import{j as s,P as e,i as W,d as D,a as B,r as d,s as C,e as y,p as w,h as $}from"./index-DSFv4uQF.js";import{M as V}from"./bootstrap.esm-CPbp9n-C.js";import{P as G}from"./Pagination-64yuHben.js";function P({state:h,orderList:a,targetOrder:t,openOrderModal:x,handleChangeOption:i,setTargetOrder:p}){return s.jsx(s.Fragment,{children:s.jsxs("table",{className:"table mt-2 table-hover",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"table-success border-2",children:[s.jsx("th",{children:"訂單號碼"}),s.jsx("th",{children:"訂單日期"}),s.jsx("th",{children:"訂購人"}),s.jsx("th",{className:"text-center",children:"付款狀態"}),s.jsx("th",{className:"text-center",children:"訂單金額"}),s.jsx("th",{className:"text-center",children:"訂單內容"})]})}),s.jsx("tbody",{className:"align-middle",children:a==null?void 0:a.map(l=>{var r;return s.jsxs("tr",{children:[s.jsx("td",{className:"text-break",children:l.id}),s.jsx("td",{children:new Date(l.create_at*1e3).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}),s.jsx("td",{children:(r=l.user)==null?void 0:r.name}),s.jsxs("td",{className:`text-center fw-bold ${l.is_paid?"text-success":"text-danger"}`,children:[l.is_paid?"已付款":"未付款",s.jsxs("select",{value:l.is_paid?"Y":"N",onChange:m=>{window.confirm("確定要變更付款狀態嗎？")&&i(m,l)},className:"ms-2",disabled:l==null?void 0:l.is_paid,children:[s.jsx("option",{value:"Y",children:"Y"}),s.jsx("option",{value:"N",children:"N"})]})]}),s.jsxs("td",{className:"text-center text-primary fw-bold",children:[l.total," 元"]}),s.jsx("td",{className:"text-center",children:s.jsx("div",{className:"btn-group",children:s.jsx("button",{type:"button",className:`btn ${(l==null?void 0:l.id)===(t==null?void 0:t.id)?"btn-secondary btn-sm":"btn-outline-secondary btn-sm"}`,disabled:h,onClick:()=>{p(l),x(l)},children:s.jsx("i",{className:"fas fa-search"})})})})]},l.id)})})]})})}P.propTypes={state:e.bool.isRequired,orderList:e.arrayOf(e.shape({id:e.oneOfType([e.string,e.number]).isRequired,create_at:e.number.isRequired,is_paid:e.bool.isRequired,total:e.number.isRequired,user:e.shape({name:e.string})})).isRequired,targetOrder:e.shape({id:e.oneOfType([e.string,e.number])}).isRequired,openOrderModal:e.func.isRequired,handleChangeOption:e.func.isRequired,setTargetOrder:e.func.isRequired};function S({orderModalRef:h,targetOrder:a,closeOrderModal:t,handleChangeOption:x}){var p,l,r,m;const i=Object.values((a==null?void 0:a.products)||{});return s.jsx("div",{className:"modal fade",ref:h,tabIndex:"-1","aria-labelledby":"exampleModalLabel","aria-hidden":"true",style:{backgroundColor:"rgba(0,0,0,0.5)"},children:s.jsx("div",{className:"modal-dialog",style:{maxWidth:"720px"},children:s.jsxs("div",{className:"modal-content",children:[s.jsxs("div",{className:"modal-header bg-success",children:[s.jsxs("h5",{className:"modal-title text-white",id:"exampleModalLabel",children:["訂單內容: ",a.id]}),s.jsx("button",{type:"button",className:"btn-close bg-white","data-bs-dismiss":"modal","aria-label":"Close",onClick:()=>t()})]}),s.jsx("div",{className:"modal-body",children:s.jsxs("div",{className:"row",children:[s.jsx("div",{className:"col-md-5",children:s.jsxs("div",{className:"p-3 pb-0 rounded",style:{backgroundColor:"rgba(255, 255, 255, 0.9)"},children:[s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label fw-bold text-dark",children:"收件人姓名"}),s.jsx("p",{className:"text-break text-primary",children:(p=a==null?void 0:a.user)==null?void 0:p.name})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label fw-bold text-dark",children:"收件人信箱"}),s.jsx("p",{className:"text-break text-primary",children:(l=a==null?void 0:a.user)==null?void 0:l.email})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label fw-bold text-dark",children:"收件人電話"}),s.jsx("p",{className:"text-break text-primary",children:(r=a==null?void 0:a.user)==null?void 0:r.tel})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label fw-bold text-dark",children:"收件人地址"}),s.jsx("p",{className:"text-break text-primary",style:{wordBreak:"break-word"},children:(m=a==null?void 0:a.user)==null?void 0:m.address})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label fw-bold text-dark",children:"總金額"}),s.jsxs("p",{className:"text-break text-danger fw-bold fs-4",children:[a==null?void 0:a.total," 元"]})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label fw-bold text-dark",children:"付款狀態"}),s.jsxs("p",{className:`text-break fw-bold fs-4 ${a.is_paid?"text-success":"text-danger"}`,children:[a!=null&&a.is_paid?"已付款":"未付款",s.jsxs("select",{value:a.is_paid?"Y":"N",className:"ms-2",onChange:n=>{window.confirm("確定要變更付款狀態嗎？")&&x(n,a)},disabled:a==null?void 0:a.is_paid,children:[s.jsx("option",{value:"Y",children:"Y"}),s.jsx("option",{value:"N",children:"N"})]})]})]})]})}),s.jsx("div",{className:"col-md-7 mb-3",children:s.jsx("div",{className:"p-3 rounded",style:{backgroundColor:"rgba(255, 255, 255, 0.2)",backdropFilter:"blur(8px)"},children:i==null?void 0:i.map(n=>{var f,j;return s.jsxs("div",{className:"d-flex align-items-center border-bottom py-2",children:[s.jsx("img",{src:(f=n==null?void 0:n.product)==null?void 0:f.imageUrl,className:"rounded border border-gold",alt:"商品圖片",width:"100"}),s.jsxs("div",{className:"ms-3 flex-grow-1",children:[s.jsx("h6",{className:"text-white",children:(j=n==null?void 0:n.product)==null?void 0:j.title}),s.jsx("small",{className:"text-dark mt-3",children:s.jsxs("div",{className:"row",children:[s.jsxs("div",{className:"col-12 col-md-6",children:["數量: ",n==null?void 0:n.qty]}),s.jsxs("div",{className:"col-12 col-md-6 text-end",children:["小計: ",n==null?void 0:n.total," 元"]})]})})]})]},n==null?void 0:n.id)})})})]})}),s.jsx("div",{className:"modal-footer",children:s.jsx("button",{type:"button",className:"btn btn-success w-100",onClick:()=>t(),children:"關閉"})})]})})})}S.propTypes={orderModalRef:e.shape({current:e.any}).isRequired,targetOrder:e.shape({id:e.oneOfType([e.string,e.number]),is_paid:e.bool,total:e.number,user:e.shape({name:e.string,email:e.string,address:e.string,tel:e.string}),products:e.objectOf(e.shape({id:e.oneOfType([e.string,e.number]),qty:e.number.isRequired,total:e.number.isRequired,product:e.shape({title:e.string,imageUrl:e.string})}))}),closeOrderModal:e.func.isRequired,handleChangeOption:e.func.isRequired};function X(){const h="https://ec-course-api.hexschool.io",a="imsmallnew",{page:t}=W(),x=D(),i=B(),[p,l]=d.useState({}),[r,m]=d.useState(Number(t)),[n,f]=d.useState([]),[j,g]=d.useState({}),[L,Y]=d.useState(!1),[U]=d.useState("admin"),[z]=d.useState({}),k=d.useRef(null),N=d.useRef(null),R=d.useCallback(async c=>{var o,b;i(C("讀取中..."));try{await y.get(`${h}/v2/api/${a}/orders?page=${c}`).then(u=>{f(u.data.orders),l(u.data.pagination)})}catch(u){console.error(u),i(w({title:"系統提示",text:((b=(o=u==null?void 0:u.response)==null?void 0:o.data)==null?void 0:b.message)||"取得商品資料失敗",status:"failed"}))}finally{i($())}},[h,a,i]),q=d.useCallback(async()=>{var c,o;i(C("讀取中..."));try{await y.post(`${h}/v2/api/user/check`)}catch(b){i(w({title:"系統提示",text:((o=(c=b==null?void 0:b.response)==null?void 0:c.data)==null?void 0:o.message)||"驗證登入失敗",status:"failed"})),x("/login")}finally{i($())}},[h,i,x]);d.useEffect(()=>{const c=document.cookie.replace(/(?:(?:^|.*;\s*)reactHWToken\s*=\s*([^;]*).*$)|^.*$/,"$1");c.length>0?(y.defaults.headers.common.Authorization=c,q()):x("/login")},[q,x]),d.useEffect(()=>{R(r)},[r,R]),d.useEffect(()=>{Number(t)!==r&&m(Number(t))},[t,m,r]);const A=c=>{m(c),x(`/admin/orders/${c}`,{replace:!0})},F=async c=>{i(C("更新付款狀態中..."));try{await y.post(`${h}/v2/api/${a}/pay/${c.id}`),R(r)}catch(o){console.error(o)}finally{i($())}},M=async(c,o)=>{var T,E;const b=c.target.value==="Y"?1:0,u={...o,is_enabled:b};try{await F(u);const v=u.is_enabled===1?"已付款":"未付款";i(w({title:"更新付款狀態成功",text:`訂單號碼: ${o.id}<br />訂購人: ${o.user.email}<br />狀態: ${v}`,status:"success"})),_()}catch(v){i(w({title:"系統提示",text:((E=(T=v==null?void 0:v.response)==null?void 0:T.data)==null?void 0:E.message)||`[訂單號碼]${o.id}: 更新付款狀態失敗`,status:"failed"}))}};d.useEffect(()=>{k.current&&(N.current=new V(k.current,{backdrop:!1}))},[]);const H=c=>{g(c),setTimeout(()=>{Y(!1)},500),N.current?N.current.show():console.error("Modal instance is not initialized.")},_=()=>{N.current?(N.current.hide(),setTimeout(()=>{g({})},500)):console.error("Modal instance is not initialized.")};return window.addEventListener("hide.bs.modal",()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()}),s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"container main",children:s.jsx("div",{className:"container",children:s.jsx("div",{className:"row",children:s.jsxs("div",{className:"col-md-12 mt-4 mb-5",children:[s.jsx(P,{state:L,orderList:n,targetOrder:j,openOrderModal:H,handleChangeOption:M,setTargetOrder:g}),s.jsx(G,{pageInfo:p,handlePageChange:A})]})})})}),s.jsx(S,{orderModalRef:k,targetOrder:j,navigation:U,cartItem:z,closeOrderModal:_,handleChangeOption:M})]})}export{X as default};
